# Project Status Summary (2026-02-11)

**Last updated:** 2026-02-11 after strict semantics merge

---

## Quick Status

✅ **Code complete** - All infrastructure in place
✅ **Tests passing** - 75/75 tests (17 SDPB + 28 Stage A + 30 Stage B)
✅ **Strict semantics merged** - No more silent failures
⏳ **Blocked on:** SDPB timeout characterization

**Next action:** Run `bash jobs/submit_stage_a_runtime_envelope.sh`

---

## What's Working

### Infrastructure ✓
- [x] Conformal block engine (Milestone 1)
- [x] Spectrum discretization (Milestone 2)
- [x] LP builder & solver with SDPB backend (Milestone 3)
- [x] Stage A scan (Milestone 4)
- [x] Stage B scan (Milestone 5)
- [x] Plotting & validation (Milestone 6)
- [x] SDPB integration for arbitrary precision (Milestone 7)
- [x] Block cache consolidation (520K files → single .npz)
- [x] Strict SDPB failure handling
- [x] Stage B epsilon anchoring
- [x] Merge gate validation

### Fixes Applied ✓
- [x] LP conditioning bug (scipy → SDPB)
- [x] NFS I/O bottleneck (consolidated cache)
- [x] SDPB MPI oversubscription (`--oversubscribe` flag)
- [x] Memory allocation (128G)
- [x] SDPB error handling bug (strict semantics)
- [x] Python stdout buffering (`PYTHONUNBUFFERED=1`)

---

## What's Not Working

### Current Blocker
**SDPB timeout too short for n_max=10**
- Problem size: 520,476 operators → 470,476 SDP blocks
- Current default: 1800s (30 minutes)
- Actual need: Unknown (>10 min confirmed, likely 30-60 min)
- Memory: Sufficient (128G, used 70GB)
- No crashes, just timing out

---

## Recent History

### 2026-02-11: Strict Semantics Merge
- Merged `codex/strict-failfast-stageb-snap-eps` → `main`
- All 75 tests passing
- Documentation updated
- Branch needs to be pushed to GitHub and deleted

### 2026-02-10: Error Handling Fix
- Fixed SDPB error handling bug (commit dcc9f12)
- Test job 59829443 correctly detected timeouts
- Discovered timeout is too short (not OOM, not MPI error)

### 2026-02-09: Multiple Failed Attempts
- Run 1 (59681179): MPI error (missing `--oversubscribe`)
- Run 2 (59716207): OOM at 48G
- Run 3 (59766497): Canceled (account switch)
- Run 4 (59766814): OOM at 64G

### Earlier: Infrastructure Builds
- SDPB integration for LP conditioning
- Block cache consolidation
- Full test suite (308+ tests)

---

## Next Steps (Prioritized)

### 1. Push Git Changes (Required)
```bash
git push origin main
git push origin --delete codex/strict-failfast-stageb-snap-eps
```

### 2. Runtime Envelope Characterization (Critical Path)

**Goal:** Find the correct SDPB timeout for a single Δσ point

**Try in order:**
```bash
# Baseline (30 min timeout, 8 cores, 128G)
bash jobs/submit_stage_a_runtime_envelope.sh

# If timed out: double timeout
TIMEOUT=3600 bash jobs/submit_stage_a_runtime_envelope.sh

# If still timed out: more cores + memory margin
TIMEOUT=3600 CPUS=16 MEM=160G WALLTIME=08:00:00 \
  bash jobs/submit_stage_a_runtime_envelope.sh

# Last resort: relax tolerance
TIMEOUT=3600 TOLERANCE=1e-3 bash jobs/submit_stage_a_runtime_envelope.sh
```

**Check result:**
```bash
sacct -j <JOBID> --format=JobID,State,ExitCode,Elapsed,MaxRSS,ReqMem
cat data/test_sufficient_memory.csv
tail -100 logs/test_sufficient_memory_<JOBID>.log
```

**Success criterion:** CSV shows `0.518000,1.41XXXX` (not NaN, not 2.5)

### 3. Pilot Run (After Envelope Success)

Once you know the correct timeout (e.g., 3600s, 16 cores):
```bash
sbatch --array=0,9,18,27,36 \
  --cpus-per-task=16 \
  --mem=160G \
  --time=12:00:00 \
  --export=ALL,SDPB_TIMEOUT=3600,STAGE_A_TOLERANCE=1e-4 \
  jobs/stage_a_pilot_sdpb.slurm

# Merge pilot results
bash jobs/merge_stage_a_pilot.sh

# Validate
cat data/eps_bound_pilot.csv
```

### 4. Full Pipeline (After Pilot Success)

```bash
sbatch --array=0-50 \
  --cpus-per-task=16 \
  --mem=160G \
  --time=12:00:00 \
  --export=ALL,SDPB_TIMEOUT=3600,STAGE_A_TOLERANCE=1e-4 \
  jobs/stage_a_sdpb.slurm

# Or use the pipeline launcher
SDPB_TIMEOUT=3600 \
STAGE_A_CPUS=16 \
STAGE_A_MEM=160G \
bash jobs/run_pipeline.sh
```

---

## Expected Results (From Paper)

At Δσ ≈ 0.5182 (3D Ising critical point):
- **Δε_max ≈ 1.41** (first scalar gap)
- **Δε'_max ≈ 3.84** (second scalar gap)

Smooth curve from Δσ=0.500 to 0.600 (51 points)

---

## Key Files & Documentation

### Current Status
- **This file**: Project overview and next steps
- `HANDOFF_2026-02-11_STRICT_SEMANTICS_MERGED.md`: Detailed merge handoff
- `CLAUDE.md`: Pipeline status and common pitfalls
- `docs/SDPB_RUNTIME_ENVELOPE_2026-02-11.md`: Runtime characterization workflow

### Historical Context
- `HANDOFF_2026-02-10_ERROR_HANDLING_FIX.md`: Previous handoff (superseded)
- `docs/LP_CONDITIONING_BUG.md`: Why we need SDPB
- `docs/SDPB_MPI_FIX.md`: MPI oversubscription fix
- `docs/PROGRESS.md`: Full implementation timeline

### Tests
```bash
# Run all tests
conda activate ising_bootstrap
pytest tests/

# Run specific suites
pytest tests/test_lp/test_sdpb.py -q
pytest tests/test_scans/test_stage_a.py -q
pytest tests/test_scans/test_stage_b.py -q
```

---

## Resource Requirements (Current Best Guess)

Based on test job 59829443:

| Resource | Baseline | Likely Needed | Notes |
|----------|----------|---------------|-------|
| Memory | 128G | 128-160G | Used 70G, margin for safety |
| CPUs | 8 | 16 | SDPB scales well with MPI |
| SDPB timeout | 1800s | 3600s | Needs characterization |
| Wall time | 12h | 12h | Should be sufficient |
| Account | randall_lab | randall_lab | Has quota |
| Partition | shared | shared | Works fine |

---

## Strict Semantics Impact (2026-02-11)

**What changed:**
- ANY SDPB timeout/failure → NaN for that point (no retries)
- Stage B requires anchored epsilon on scalar grid
- Merge gate validates Stage A before launching Stage B

**Why this is good:**
- No more silent failures producing garbage results (2.5 bug)
- Clear signal when timeout is too short
- Forces proper configuration before production runs

**Why this requires envelope characterization:**
- Must find correct timeout BEFORE running full array
- Strict semantics won't paper over configuration issues

---

## Success Checklist

- [x] All code implemented and tested
- [x] Strict semantics merged
- [ ] Git changes pushed to GitHub
- [ ] Codex branch deleted
- [ ] Runtime envelope characterized
- [ ] Correct SDPB timeout identified
- [ ] Pilot run successful
- [ ] Full Stage A array completes
- [ ] Stage B completes
- [ ] Figure 6 matches paper

**Status: 40% complete (infrastructure done, need runtime tuning)**

---

## Contact Points

- **Main handoff**: `HANDOFF_2026-02-11_STRICT_SEMANTICS_MERGED.md`
- **Runtime workflow**: `docs/SDPB_RUNTIME_ENVELOPE_2026-02-11.md`
- **Quick reference**: This file
- **Troubleshooting**: `CLAUDE.md` (What Failure Looks Like section)

---

**Updated:** 2026-02-11 by Claude
